<!DOCTYPE html>  <html> <head>   <title>clients.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="client.html">                 client.coffee               </a>                                           <a class="source" href="clients.html">                 clients.coffee               </a>                                           <a class="source" href="log.html">                 log.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               clients.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">url			= </span><span class="nx">require</span> <span class="s1">&#39;url&#39;</span>
<span class="nv">sys			= </span><span class="nx">require</span> <span class="s1">&#39;sys&#39;</span>
<span class="nv">Events		= </span><span class="nx">require</span> <span class="s1">&#39;events&#39;</span> 
<span class="nv">Client		= </span><span class="nx">require</span> <span class="s1">&#39;client&#39;</span>
<span class="nv">Log			= </span><span class="nx">require</span> <span class="s1">&#39;log&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Clients</h1>

<p>Clients module is one of the core server components. Its responsible to hold the list of all
clients which are connected to the server. Its able to broadcast message to everybody connected.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Clients = module.exports = </span><span class="nf">() -&gt;</span>
	<span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
	<span class="vi">@count = </span><span class="mi">0</span>

<span class="nx">sys</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Clients</span><span class="p">,</span> <span class="nx">Events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Connect</h2>

<p>Method called if upgrade request was generated by underlaying http.Server. In order to connect new user
to the server we have to validate if client request contain all necessary headers to be
able to start handshake process. If everything is ok handshake process is started in order
to establish communication.</p>

<p>If there is anything wrong with request headers the client is closed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Clients.prototype.connect = </span><span class="nf">(client) -&gt;</span>
	<span class="k">if</span> <span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s2">&quot;GET&quot;</span> <span class="o">and</span> 
	<span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">upgrade</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;websocket&#39;</span> <span class="o">and</span> 
	<span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;upgrade&#39;</span>
		<span class="vi">@list = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">@list</span><span class="o">?</span>
		</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Dont add new client if its already connected.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">@list</span><span class="p">[</span><span class="nx">client</span><span class="p">.</span><span class="nx">sid</span><span class="p">]</span><span class="o">?</span>
			<span class="k">return</span>
		
		<span class="nx">@list</span><span class="p">[</span><span class="nx">client</span><span class="p">.</span><span class="nx">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">client</span>
		<span class="nx">@count</span><span class="o">++</span>

		<span class="nx">client</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">@emit</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">data</span>
		
		<span class="nx">client</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">Log</span><span class="p">.</span><span class="nx">greenify</span><span class="p">(</span><span class="s1">&#39;[clients]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; new connection&#39;</span>
			<span class="nx">@emit</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="nx">client</span>
		
		<span class="nx">client</span><span class="p">.</span><span class="nx">handshake</span><span class="p">()</span>
	<span class="k">else</span>
		<span class="nx">client</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Disconnect</h2>

<p>Disconnect client from the server.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Clients.prototype.disconnect = </span><span class="nf">(client) -&gt;</span>
	<span class="nx">client</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
	<span class="k">delete</span> <span class="nx">@list</span><span class="p">[</span><span class="nx">client</span><span class="p">.</span><span class="nx">sid</span><span class="p">]</span>
	<span class="nx">@count</span><span class="o">--</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>DisconnectAll</h2>

<p>Close connection for all clients on the server.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Clients.prototype.disconnectAll = </span><span class="nf">() -&gt;</span>
	<span class="p">(</span><span class="nx">@list</span><span class="p">[</span><span class="nx">sid</span><span class="p">].</span><span class="nx">close</span><span class="p">()</span>
	<span class="k">delete</span> <span class="nx">@list</span><span class="p">[</span><span class="nx">sid</span><span class="p">])</span> <span class="k">for</span> <span class="nx">sid</span> <span class="k">of</span> <span class="nx">@list</span>
	<span class="vi">@count = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Broadcast</h2>

<p>Send the message to all connected clients. Message is sent to all clients connected to server
which are connected and handshaked. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Clients.prototype.broadcast = </span><span class="nf">(data) -&gt;</span>
	<span class="p">(</span><span class="k">if</span> <span class="nx">@list</span><span class="p">[</span><span class="nx">sid</span><span class="p">].</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">Client</span><span class="p">.</span><span class="nx">STATUS_READY</span>
		<span class="nx">@list</span><span class="p">[</span><span class="nx">sid</span><span class="p">].</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="k">for</span> <span class="nx">sid</span> <span class="k">of</span> <span class="nx">@list</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 